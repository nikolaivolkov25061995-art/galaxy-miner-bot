import logging
import sqlite3
import random
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

TOKEN = "8531754531:AAEfhcjkA3nqMf78MSJ-tBLl4ImTOB9LiWs"

# –°–∏—Å—Ç–µ–º–∞ –∫–ª–∞—Å—Å–æ–≤
CLASSES = {
    'warrior': {'name': '‚öîÔ∏è –í–æ–∏–Ω', 'stats': {'strength': 15, 'agility': 8, 'intelligence': 5}},
    'mage': {'name': 'üîÆ –ú–∞–≥', 'stats': {'strength': 5, 'agility': 9, 'intelligence': 18}},
    'hunter': {'name': 'üèπ –û—Ö–æ—Ç–Ω–∏–∫', 'stats': {'strength': 10, 'agility': 16, 'intelligence': 7}}
}

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('galaxy_bot.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS players
                 (user_id INTEGER PRIMARY KEY, username TEXT, class TEXT,
                  level INTEGER DEFAULT 1, exp INTEGER DEFAULT 0, energy INTEGER DEFAULT 100)''')
    conn.commit()
    conn.close()

init_db()

class Player:
    def __init__(self, user_id):
        self.user_id = user_id
        self.load()
    
    def load(self):
        conn = sqlite3.connect('galaxy_bot.db')
        c = conn.cursor()
        c.execute('SELECT * FROM players WHERE user_id = ?', (self.user_id,))
        row = c.fetchone()
        conn.close()
        if row:
            self.username, self.class_type, self.level, self.exp, self.energy = row[1:]
            return True
        return False
    
    def create(self, username, class_type):
        conn = sqlite3.connect('galaxy_bot.db')
        c = conn.cursor()
        c.execute('INSERT INTO players (user_id, username, class, level, exp, energy) VALUES (?, ?, ?, ?, ?, ?)',
                 (self.user_id, username, class_type, 1, 0, 100))
        conn.commit()
        conn.close()
        self.username = username
        self.class_type = class_type
        self.level = 1
        self.exp = 0
        self.energy = 100
    
    def save(self):
        conn = sqlite3.connect('galaxy_bot.db')
        c = conn.cursor()
        c.execute('UPDATE players SET level=?, exp=?, energy=? WHERE user_id=?',
                 (self.level, self.exp, self.energy, self.user_id))
        conn.commit()
        conn.close()

# –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    player = Player(user.id)
    
    if player.load():
        await update.message.reply_text(
            f"üöÄ –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {player.username}!\n"
            f"üéØ –ö–ª–∞—Å—Å: {CLASSES[player.class_type]['name']}\n"
            f"üèÖ –£—Ä–æ–≤–µ–Ω—å: {player.level} | ‚ö° –≠–Ω–µ—Ä–≥–∏—è: {player.energy}\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/hunt - üéØ –û—Ö–æ—Ç–∞\n"
            "/profile - üìä –ü—Ä–æ—Ñ–∏–ª—å"
        )
    else:
        keyboard = [[InlineKeyboardButton(cls['name'], callback_data=f"class_{cid}")] 
                   for cid, cls in CLASSES.items()]
        await update.message.reply_text(
            "üåå –í—ã–±–µ—Ä–∏ —Å–≤–æ–π –∫–ª–∞—Å—Å:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

async def create_character(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user = query.from_user
    class_id = query.data.split('_')[1]
    
    player = Player(user.id)
    player.create(user.first_name, class_id)
    
    await query.edit_message_text(
        f"üéâ –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω!\n"
        f"üéØ –ö–ª–∞—Å—Å: {CLASSES[class_id]['name']}\n\n"
        f"üöÄ –ò—Å–ø–æ–ª—å–∑—É–π /hunt –¥–ª—è –æ—Ö–æ—Ç—ã!\n"
        f"üìä –ò—Å–ø–æ–ª—å–∑—É–π /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è"
    )

async def hunt(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    player = Player(user.id)
    
    if not player.load():
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —á–µ—Ä–µ–∑ /start")
        return
    
    if player.energy < 10:
        await update.message.reply_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!")
        return
    
    player.energy -= 10
    exp_gain = random.randint(15, 25)
    player.exp += exp_gain
    
    if player.exp >= 100:
        player.level += 1
        player.exp = 0
        level_msg = f"üéâ –î–æ—Å—Ç–∏–≥–Ω—É—Ç —É—Ä–æ–≤–µ–Ω—å {player.level}!"
    else:
        level_msg = ""
    
    player.save()
    
    await update.message.reply_text(
        f"‚úÖ –û—Ö–æ—Ç–∞ —É—Å–ø–µ—à–Ω–∞!\n"
        f"üí´ +{exp_gain} –æ–ø—ã—Ç–∞\n"
        f"{level_msg}\n"
        f"‚ö° –≠–Ω–µ—Ä–≥–∏—è: {player.energy}"
    )

async def profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    player = Player(user.id)
    
    if not player.load():
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —á–µ—Ä–µ–∑ /start")
        return
    
    await update.message.reply_text(
        f"üìä –ü–†–û–§–ò–õ–¨ {player.username}\n\n"
        f"üéØ –ö–ª–∞—Å—Å: {CLASSES[player.class_type]['name']}\n"
        f"üèÖ –£—Ä–æ–≤–µ–Ω—å: {player.level}\n"
        f"üí´ –û–ø—ã—Ç: {player.exp}/100\n"
        f"‚ö° –≠–Ω–µ—Ä–≥–∏—è: {player.energy}"
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
def main():
    app = Application.builder().token(TOKEN).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("hunt", hunt))
    app.add_handler(CommandHandler("profile", profile))
    app.add_handler(CallbackQueryHandler(create_character, pattern="^class_"))
    
    print("üöÄ Galaxy Miner Bot –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling()

if __name__ == '__main__':
    main()
